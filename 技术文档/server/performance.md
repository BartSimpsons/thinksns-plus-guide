# <p align="center">ThinkSNS Plus 性能简述</p>

## 概述

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;本文档主要描述ThinkSNS Plus服务端系统性能、服务端高性能部署方案及优化措施、服务端系统持续优化及升级策略。本文档未涉及前端（PC站点、H5站点、Android、IOS）性能方案。

## 系统吞吐量

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;压测的服务器为一台阿里云ECS服务器，服务器配置为2vCPU/4GB/5Mbps/普通云盘200G。安装thinksns plus后给数据库添加了少量数据，保证每个接口都是有数据的状态；然后在服务器本地压测一些常用的数据读取接口，压测结果吞吐量为30QPS左右。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;30QPS是指系统在每秒可以处理30个请求，一天有86400秒，算下来一天可以处理约260万个请求；根据thinksns plus移动端统计，平均每页面3个请求，假设用户每日平均访问50个页面，计算结果为支持1.7万左右的日活用户（日活用户不是注册会员数量）。当然，这样计算出来的结果是不准确的，计算中没有考虑峰值和其他因素，需要根据实际业务做分析。

## 系统部署和优化

### 系统和基础软件优化

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;优化系统和基础软件（nginx、mysql、php等）能让系统支持更多的连接数和请求，并且运行起来更稳定。具体的优化项根据不同的系统环境和业务需求，自行百度或谷歌上面有非常多的优化教程，不在一一列举。

### ThinkSNS Plus部署优化

1. 使用php7，php7较之前的php5版本性能提升一倍以上。
2. 开启PHP OPcache，生产环境应该开启OPcache，性能会有巨大提升。
3. 关闭调试模式，.env文件中，APP_DEBUG设置为false；可减少程序逻辑处理。
4. 配置信息缓存 php artisan config:cache，缓存配置文件，减少磁盘IO。
5. 路由缓存 php artisan route:cache，缓存路由文件，减少磁盘IO。
6. 自动加载优化 composer dumpautoload，优化自动加载。
7. 配置并使用 redis /memcached来存储会话，从内存中读取会话信息没有磁盘IO。
8. 配置并使用 redis /memcached来存储缓存数据，从内存中读取缓存数据没有磁盘IO。
9. 将程序和数据安装到SSD磁盘；以阿里云ECS云盘为例：SSD云盘16000IOPS+，而所谓的高效云盘不过3000IOPS；SSD云盘效率是高效云盘的五倍以上。
10. 采用独立的数据库服务器或采用云数据库如阿里云：RDS。
11. 采用独立的缓存服务器或采用云缓存系统。
12. 使用CDN加速图片、视频、文件的访问和下载。
13. 挂载单独的磁盘用于存储图片、视频和其他用户上传的文件。

> 以上优化项#7~#13都不是必须的，但是建议都进行配置或选择性配置。按要求优化以上内容之后，整体性能可以提高一倍以上。


### 分布式部署

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;分布式部署为解决更大的业务需求，如更大的请求峰值、数据库读写性能瓶颈，网络带宽瓶颈等；目标为建立高可用性系统，单点故障不影响系统服务。目前thinksns plus支持的分布式部署方案如下：

- 应用程序负载均衡，多台服务器部署thinksns plus系统，通过负载均衡器转发请求到部署的服务器。thinsns plus 无需任何配置，但是要将会话数据、缓存数据、用户上传文件单独部署，也就是上面“thinksns plus 部署优化中的#7、#8、#10、#13条”。
- 数据库读写分离，安装好数据库之后，只需在简单配置即可支持，也可以使用云数据库做读写分离。
- 分布式缓存系统，搭建好分布式缓存服务器后仅需简单配置即可支持，也可以采用兼容redis协议的云缓存系统。
- 分布式文件系统（目前不支持，已列入计划，之后会支持云存储）

## 系统优化和升级

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;以上提及的各种优化部署策略，部分都是建立在增加服务器的基础上提升系统的处理能力，并未涉及到系统程序的优化，那是不是程序优化就不重要了？

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;当然不是，在业务初期，增加服务器可以快速扩容系统处理能力，而且也是性价比最高的方式；假如聘一个人专门优化程序，一年10万薪资，那这个人一年能提高程序的一倍性能也是很不错了，但这十万要是花在服务器上面，性能可能立即提高10倍。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;而且，thinksns plus产品研发团队每天都在优化和改进产品，每次版本迭代，已安装的thinksns plus程序都可以通过自动或手动的方式合并最新的特性，这其中有很多特性就是针对于性能的优化。保持更新不间断，已安装的thinksns plus程序性能也将越来越好。



